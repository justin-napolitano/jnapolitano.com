

<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow">
<meta name="revisit-after" content="15 days"><link rel="author" href="/jnapolitano.com/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/jnapolitano.com/apple-touch-icon.png"><link rel="icon" href="/jnapolitano.com/favicon.ico" type="image/x-icon"><link rel="icon" type="image/png" sizes="32x32" href="/jnapolitano.com/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/jnapolitano.com/favicon-16x16.png">
<link rel="manifest" href="/jnapolitano.com/site.webmanifest">
<meta name="msapplication-TileImage" content="/jnapolitano.com/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/jnapolitano.com/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="Justin Napolitano"><meta name="description" content="Flattening and injesting JSON into data lake.. Autonomously. ">
<meta itemprop="name" content="GCP Cloud Run: LOC Flattener">
<meta itemprop="description" content="Flattening and injesting JSON into data lake.. Autonomously. "><meta itemprop="datePublished" content="2024-07-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-07-11T16:24:23-05:00" />
<meta itemprop="wordCount" content="5685"><meta itemprop="image" content="jnapolitano.com/images/feature-gcp.png">
<meta itemprop="keywords" content="git,python,gcp,bash,workflow automation,docker,containerization," /><meta property="og:title" content="GCP Cloud Run: LOC Flattener" />
<meta property="og:description" content="Flattening and injesting JSON into data lake.. Autonomously. " />
<meta property="og:type" content="article" />
<meta property="og:url" content="jnapolitano.com/posts/loc_normalizer/" /><meta property="og:image" content="jnapolitano.com/images/feature-gcp.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-11T16:24:23-05:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="jnapolitano.com/images/feature-gcp.png"/>

<meta name="twitter:title" content="GCP Cloud Run: LOC Flattener"/>
<meta name="twitter:description" content="Flattening and injesting JSON into data lake.. Autonomously. "/>
<title>GCP Cloud Run: LOC Flattener</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="/jnapolitano.com/css/style.min.e0b1c1b8d997f495fcb6256067ff9553b62e50837603056ab2905cd59b0b5e73.css" integrity="sha256-4LHBuNmX9JX8tiVgZ/+VU7YuUIN2AwVqspBc1ZsLXnM=" crossorigin="anonymous">
	<style>.bg-img {background-image: url('jnapolitano.com/images/feature-gcp.png');}</style></head>
<body id="page">
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="jnapolitano.com">Justin Napolitano</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="jnapolitano.com/posts/">POSTS</a><a href="https://jnapolitano.com/en/categories/projects/">PROJECTS</a><a href="https://jnapolitano.com/en/categories/adventures/">ADVENTURES</a><a href="https://jnapolitano.com/resume.pdf">RESUME</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/justin-napolitano" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/justin-napolitano/" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="mailto:personal.jnapolitano@gmail.com" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="https://instagram.com/jay_burdie" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://mastodon.social/@jnapolitano" target="_blank" rel="noopener me" title="Mastodon"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m 21.474,13.998 c -0.296,1.526 -2.655,3.194 -5.365,3.519 -1.413,0.168 -2.804,0.323 -4.287,0.255 -2.426,-0.111 -4.34,-0.579 -4.34,-0.579 0,0.236 0.015,0.461 0.044,0.672 0.316,2.394 2.373,2.537 4.323,2.604 1.968,0.067 3.721,-0.486 3.721,-0.486 l 0.081,1.779 c 0,0 -1.377,0.739 -3.829,0.875 -1.352,0.075 -3.031,-0.034 -4.987,-0.551 C 2.594,20.963 1.865,16.442 1.752,11.855 1.719,10.493 1.741,9.209 1.741,8.134 1.741,3.443 4.814,2.069 4.814,2.069 6.363,1.356 9.022,1.056 11.787,1.035 h 0.067 c 2.764,0.022 5.426,0.322 6.975,1.033 0,0 3.073,1.375 3.073,6.066 0,0 0.039,3.461 -0.428,5.864"/><path d="M 6.464,13.231 V 7.973 c 0,-1.002 0.549,-2.613 2.613,-2.613 2.064,0 2.741,1.793 2.741,3.484 0,1.692 0,2.23 0,2.23"/><path d="M 17.173,13.231 V 7.973 c 0,-1.002 -0.549,-2.613 -2.613,-2.613 -2.064,0 -2.741,1.793 -2.741,3.484 0,1.692 -0,2.23 -0,2.23"/></svg></a><a href="https://x.com/jayburdybird" target="_blank" rel="noopener me" title="X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6"/></svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=jnapolitano.com%2fposts%2floc_normalizer%2f&amp;text=GCP%20Cloud%20Run%3a%20LOC%20Flattener" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6"/></svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=jnapolitano.com%2fposts%2floc_normalizer%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
        </li>
        <li>
            <a href="mailto:?subject=GCP%20Cloud%20Run%3a%20LOC%20Flattener&amp;body=jnapolitano.com%2fposts%2floc_normalizer%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=jnapolitano.com%2fposts%2floc_normalizer%2f&amp;source=jnapolitano.com&amp;title=GCP%20Cloud%20Run%3a%20LOC%20Flattener&amp;summary=GCP%20Cloud%20Run%3a%20LOC%20Flattener%2c%20by%20Justin%20Napolitano%0a%0aFlattening%20and%20injesting%20JSON%20into%20data%20lake..%20Autonomously.%20%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;GCP Cloud Run: LOC Flattener&#34;,&#34;jnapolitano.com/posts/loc_normalizer/&#34;,&#34;GCP Cloud Run: LOC Flattener, by Justin Napolitano\n\nFlattening and injesting JSON into data lake.. Autonomously. \n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="jnapolitano.com/posts/">POSTS</a></li>
			<li><a href="https://jnapolitano.com/en/categories/projects/">PROJECTS</a></li>
			<li><a href="https://jnapolitano.com/en/categories/adventures/">ADVENTURES</a></li>
			<li><a href="https://jnapolitano.com/resume.pdf">RESUME</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jul 11, 2024</span></div>
				<h1>GCP Cloud Run: LOC Flattener</h1>
			</header>
			<div class="post-info"><p>Flattening and injesting JSON into data lake.. Autonomously. </p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg><a href="" target="_blank">Justin Napolitano</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="jnapolitano.com/tags/git">git</a></span><span class="tag"><a href="jnapolitano.com/tags/python">python</a></span><span class="tag"><a href="jnapolitano.com/tags/gcp">gcp</a></span><span class="tag"><a href="jnapolitano.com/tags/bash">bash</a></span><span class="tag"><a href="jnapolitano.com/tags/workflow-automation">workflow automation</a></span><span class="tag"><a href="jnapolitano.com/tags/docker">docker</a></span><span class="tag"><a href="jnapolitano.com/tags/containerization">containerization</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span class="category"><a href="jnapolitano.com/categories/projects">projects</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
    
    
    
    
    25 Minutes, 50 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2024-07-10 19:00 -0500</p></div>
			<hr class="post-end">
			<div class="content">
				<h1 id="library-of-congress-normalizer-job">Library of Congress Normalizer Job<a href="#library-of-congress-normalizer-job" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<p>This <a href="https://github.com/justin-napolitano/loc_normalizer">repo</a> normalizes the existing library of congress schema into a db that wil then be used to construct a knowledge graph of supreme court law.</p>
<h2 id="plan">Plan<a href="#plan" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ol>
<li>Setup a venv to run locally</li>
<li>Install requirements</li>
<li>Write out the script to interface with gcp</li>
<li>Set up a docker container and test locally</li>
<li>build the image</li>
<li>upload to gcp</li>
<li>create the job</li>
</ol>
<h2 id="setup-the-venv">Setup the venv<a href="#setup-the-venv" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="install">Install<a href="#install" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I installed virtualenv locally on ubuntu</p>
<h3 id="create">Create<a href="#create" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I then run <code>virtualenv {path to venvs}</code></p>
<h3 id="activate">Activate<a href="#activate" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Then source the venv bin to activate</p>
<p><code>source {path to venv}/bin/activate</code></p>
<h3 id="install-requirements">Install requirements<a href="#install-requirements" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code> pip install -r requirements.txt</code></p>
<h2 id="write-out-the-script">Write out the Script<a href="#write-out-the-script" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="steps">Steps<a href="#steps" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>Access the loc_scraper Bucket</li>
<li>Grab a json blob</li>
<li>Process the blob</li>
<li>Move the blob to a processed bucket</li>
</ol>
<h3 id="data-organization">Data Organization<a href="#data-organization" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I want to create workflow class with the following methods</p>
<ol>
<li>get_creds</li>
<li>grab_blob</li>
<li>process_blob</li>
<li>move_blob</li>
</ol>
<p>The process_blob method will be a lot of work.  I might just flatten the json and dump into a table. I will then write a normalization workflow</p>
<h3 id="get-creds">Get Creds<a href="#get-creds" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>If running locally I will need some creds in the enviornment. I will take create a key from the console and download it for local run .</p>
<h2 id="setup-the-docker-container">Setup the Docker Container<a href="#setup-the-docker-container" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="the-dockerfile">The Dockerfile<a href="#the-dockerfile" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Also available on <a href="https://github.com/justin-napolitano/loc_normalizer/blob/main/Dockerfile">github</a></p>
<pre tabindex="0"><code># # Use the Alpine Linux base image
# FROM alpine:latest

# # Set the working directory inside the container
# WORKDIR /app

# # Copy a simple script that prints &quot;Hello, World!&quot; into the container
# COPY /src/hello.sh .

# # Make the script executable
# RUN chmod +x hello.sh

# # Define the command to run when the container starts
# CMD [&quot;./hello.sh&quot;]


# Use the official Python image from Docker Hub
FROM python:3.10-slim

# Set the working directory in the container
WORKDIR /app

# Copy the current directory contents into the container at /app
COPY ./src /app
COPY requirements.txt /app

# Install any needed dependencies specified in requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Run the Python script when the container launches
CMD [&quot;python&quot;, &quot;loc_scraper.py&quot;]
</code></pre><h2 id="quickstart">Quickstart<a href="#quickstart" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="gcloud-cli">Gcloud cli<a href="#gcloud-cli" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>After this you will have to install gcloud cli and configure you&rsquo;re local environment. I will write up some scripts in a subsequent post to automate this process&hellip; but for the time being check out this <a href="https://cloud.google.com/sdk/docs/install">&ldquo;link&rdquo;</a></p>
<h3 id="create-the-image">Create the image<a href="#create-the-image" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>In the repo there is a a bash script called <code>build.sh</code> that will need to be updated to according to your gcp project.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud builds submit --region<span class="o">=</span>us-west2 --config cloudbuild.yaml
</code></pre></div><p>It calls <code>cloudbuild.yaml</code> which might need to be updated for you, but the following the should work.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gcr.io/cloud-builders/docker&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">docker build -t us-west2-docker.pkg.dev/$PROJECT_ID/supreme-court-scraper/supreme-court-scraper-image:dev .</span><span class="w">
</span><span class="w">  </span><span class="nt">automapSubstitutions</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">images</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="s1">&#39;us-west2-docker.pkg.dev/$PROJECT_ID/supreme-court-scraper/supreme-court-scraper-image:dev&#39;</span><span class="w">
</span></code></pre></div><h3 id="following-creation-of-the-imge">Following creation of the imge<a href="#following-creation-of-the-imge" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Next you can create a job on gcp by runnning the <code>job_create.sh</code> script&hellip; or by copying the code below and chaging yourproject to the correct project-name</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud run <span class="nb">jobs</span> create supreme-court-scraper --image us-west2-docker.pkg.dev/yourproject/supreme-court-scraper/supreme-court-scraper-image:dev <span class="se">\
</span></code></pre></div><h3 id="executing-the-job">Executing the job<a href="#executing-the-job" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Once complete you can execute the job by running the <code>execute_job.sh</code> script or by running</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud run <span class="nb">jobs</span> execute supreme-court-scraper
</code></pre></div><h3 id="putting-it-all-together">Putting it all together<a href="#putting-it-all-together" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>In a perfect world the following should work. Note that src/.env should be set with your environmental variables such as <code>$GCPPROJECTID</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">source</span> src/.env <span class="se">\
</span><span class="se"></span><span class="o">&amp;&amp;</span> ./build.sh <span class="se">\ </span>
<span class="o">&amp;&amp;</span> ./job_create.sh <span class="se">\
</span><span class="se"></span><span class="o">&amp;&amp;</span> ./execute_job.sh
</code></pre></div><h2 id="running-locally">Running locally<a href="#running-locally" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The python script in the <code>/src</code> can be run locally, however it should be modified if you choose not to use gcp.  There are a number of functions within that can easily be modified to permit writing to the local directory.</p>
<h2 id="documentation-sources">Documentation Sources<a href="#documentation-sources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ol>
<li><a href="https://cloud.google.com/run/docs/create-jobs">&ldquo;Google Cloud Run Jobs Automation&rdquo;</a></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="o">../</span><span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</code></pre></div><pre><code>Requirement already satisfied: beautifulsoup4==4.12.3 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 1)) (4.12.3)
Requirement already satisfied: bs4==0.0.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 2)) (0.0.2)
Requirement already satisfied: cachetools==5.3.3 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 3)) (5.3.3)
Requirement already satisfied: certifi==2024.2.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 4)) (2024.2.2)
Requirement already satisfied: charset-normalizer==3.3.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 5)) (3.3.2)
Requirement already satisfied: flatten-json==0.1.14 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 6)) (0.1.14)
Requirement already satisfied: google-api-core==2.18.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 7)) (2.18.0)
Requirement already satisfied: google-auth==2.29.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 8)) (2.29.0)
Requirement already satisfied: google-cloud-appengine-logging==1.4.3 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 9)) (1.4.3)
Requirement already satisfied: google-cloud-audit-log==0.2.5 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 10)) (0.2.5)
Requirement already satisfied: google-cloud-core==2.4.1 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 11)) (2.4.1)
Requirement already satisfied: google-cloud-logging==3.10.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 12)) (3.10.0)
Requirement already satisfied: google-cloud-storage==2.16.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 13)) (2.16.0)
Requirement already satisfied: google-crc32c==1.5.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 14)) (1.5.0)
Requirement already satisfied: google-resumable-media==2.7.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 15)) (2.7.0)
Requirement already satisfied: googleapis-common-protos==1.63.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 16)) (1.63.0)
Requirement already satisfied: grpc-google-iam-v1==0.13.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 17)) (0.13.0)
Requirement already satisfied: grpcio==1.62.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 18)) (1.62.2)
Requirement already satisfied: grpcio-status==1.62.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 19)) (1.62.2)
Requirement already satisfied: idna==3.7 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 20)) (3.7)
Requirement already satisfied: proto-plus==1.23.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 21)) (1.23.0)
Requirement already satisfied: protobuf==4.25.3 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 22)) (4.25.3)
Requirement already satisfied: pyasn1==0.6.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 23)) (0.6.0)
Requirement already satisfied: pyasn1_modules==0.4.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 24)) (0.4.0)
Requirement already satisfied: requests==2.31.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 25)) (2.31.0)
Requirement already satisfied: rsa==4.9 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 26)) (4.9)
Requirement already satisfied: six==1.16.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 27)) (1.16.0)
Requirement already satisfied: soupsieve==2.5 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 28)) (2.5)
Requirement already satisfied: urllib3==2.2.1 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 29)) (2.2.1)
Requirement already satisfied: google-cloud-bigquery==3.25.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 40)) (3.25.0)
Collecting numpy==2.0.0 (from -r ../requirements.txt (line 51))
  Downloading numpy-2.0.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (60 kB)
[2K     [38;2;114;156;31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m60.9/60.9 kB[0m [31m1.1 MB/s[0m eta [36m0:00:00[0m[31m1.1 MB/s[0m eta [36m0:00:01[0m
[?25hCollecting packaging==24.1 (from -r ../requirements.txt (line 52))
  Downloading packaging-24.1-py3-none-any.whl.metadata (3.2 kB)
Requirement already satisfied: pandas==2.2.2 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 53)) (2.2.2)
Requirement already satisfied: pyarrow==16.1.0 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 56)) (16.1.0)
Collecting python-dateutil==2.9.0.post0 (from -r ../requirements.txt (line 59))
  Downloading python_dateutil-2.9.0.post0-py2.py3-none-any.whl.metadata (8.4 kB)
Requirement already satisfied: pytz==2024.1 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 60)) (2024.1)
Requirement already satisfied: tzdata==2024.1 in /home/cobra/.config/jupyterlab-desktop/jlab_server/lib/python3.12/site-packages (from -r ../requirements.txt (line 65)) (2024.1)
Downloading numpy-2.0.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (19.0 MB)
[2K   [38;2;114;156;31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m19.0/19.0 MB[0m [31m2.2 MB/s[0m eta [36m0:00:00[0mm eta [36m0:00:01[0m[36m0:00:01[0m
[?25hDownloading packaging-24.1-py3-none-any.whl (53 kB)
[2K   [38;2;114;156;31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m54.0/54.0 kB[0m [31m1.7 MB/s[0m eta [36m0:00:00[0m
[?25hDownloading python_dateutil-2.9.0.post0-py2.py3-none-any.whl (229 kB)
[2K   [38;2;114;156;31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━[0m [32m229.9/229.9 kB[0m [31m2.3 MB/s[0m eta [36m0:00:00[0m MB/s[0m eta [36m0:00:01[0m
[?25hInstalling collected packages: python-dateutil, packaging, numpy
  Attempting uninstall: python-dateutil
    Found existing installation: python-dateutil 2.9.0
    Uninstalling python-dateutil-2.9.0:
      Successfully uninstalled python-dateutil-2.9.0
  Attempting uninstall: packaging
    Found existing installation: packaging 24.0
    Uninstalling packaging-24.0:
      Successfully uninstalled packaging-24.0
  Attempting uninstall: numpy
    Found existing installation: numpy 1.26.4
    Uninstalling numpy-1.26.4:
      Successfully uninstalled numpy-1.26.4
Successfully installed numpy-2.0.0 packaging-24.1 python-dateutil-2.9.0.post0
Note: you may need to restart the kernel to use updated packages.
</code></pre>
<h2 id="write-out-the-script-1">Write out the Script<a href="#write-out-the-script-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="steps-1">Steps<a href="#steps-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>Initialize the Google Logging Service</li>
<li>Initialize The Google Cloud Storage Service</li>
<li>Initialize the Bigquery Client</li>
<li>Grab a json blob</li>
<li>Process the blob</li>
<li>Move the blob to a processed bucket</li>
</ol>
<h4 id="initialize-the-google-cloud-storage-service">Initialize The Google Cloud Storage Service<a href="#initialize-the-google-cloud-storage-service" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>I created a Gloud Service Client Class available at : <a href="https://github.com/justin-napolitano/gcputils/blob/bc421debf4c828522580ec79ab634b2e2bf402a4/GoogleCloudLogging.py">https://github.com/justin-napolitano/gcputils/blob/bc421debf4c828522580ec79ab634b2e2bf402a4/GoogleCloudLogging.py</a></p>
<p>It is imported below and tested below.  Note that cli specific arguments are commented out for testing in ipynb.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># loc_flattener.py</span>
<span class="c1"># library_of_congress_scraper.py</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">gcputils.gcpclient</span> <span class="kn">import</span> <span class="n">GCSClient</span>
<span class="kn">from</span> <span class="nn">gcputils.GoogleCloudLogging</span> <span class="kn">import</span> <span class="n">GoogleCloudLogging</span>
<span class="kn">from</span> <span class="nn">gcputils.BigQueryClient</span> <span class="kn">import</span> <span class="n">BigQueryClient</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">from</span> <span class="nn">flatten_json</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">import</span> <span class="nn">google.cloud.logging</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><h4 id="initialize-the-google-cloud-storage-client">Initialize the Google Cloud Storage Client<a href="#initialize-the-google-cloud-storage-client" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>The Google Cloud Storage Client is available at <a href="https://github.com/justin-napolitano/gcputils/blob/bc421debf4c828522580ec79ab634b2e2bf402a4/gcpclient.py">https://github.com/justin-napolitano/gcputils/blob/bc421debf4c828522580ec79ab634b2e2bf402a4/gcpclient.py</a></p>
<p>Calling the client and listing the buckets to test below</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
</code></pre>
<h4 id="access-the-blobs-within-the-bucket">Access the Blobs within the bucket<a href="#access-the-blobs-within-the-bucket" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>Now I need to grab a blob from the bucket. IN this case I just want to grab one from the top of the heap without pulling a lot of data into context.</p>
<h5 id="addition-to-the-storage-class">Addition to the storage class<a href="#addition-to-the-storage-class" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python">
<span class="k">def</span> <span class="nf">list_blobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Lists all blobs in the specified bucket in Google Cloud Storage.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            bucket_name (str): Name of the bucket.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            list: A list of blob names.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># Get the bucket</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        
        <span class="c1"># List all blobs in the bucket</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">())</span>
        
        <span class="n">blob_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">blob</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">blob_names</span>

<span class="k">def</span> <span class="nf">pop_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Selects and removes the first blob from the specified bucket in Google Cloud Storage.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            bucket_name (str): Name of the bucket.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            google.cloud.storage.blob.Blob: The first blob from the bucket.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># Get the bucket</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        
        <span class="c1"># List all blobs in the bucket</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blobs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;No blobs found in bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get the first blob</span>
        <span class="n">first_blob</span> <span class="o">=</span> <span class="n">blobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob selected: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">first_blob</span>

</code></pre></div><h5 id="test-run">Test Run<a href="#test-run" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
First valid blob selected: last_page.txt
First blob name: last_page.txt
</code></pre>
<h4 id="some-additions-to-avoid-last_pagetxt">Some additions to avoid last_page.txt<a href="#some-additions-to-avoid-last_pagetxt" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>So there is a last page.txt that is used by the scraper program. I want to pass some regex patterns to exclude in the pop_blob method</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">pop_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Selects and removes the first blob from the specified bucket in Google Cloud Storage,
</span><span class="s2">        excluding any blobs that match patterns from the provided file.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            bucket_name (str): Name of the bucket.
</span><span class="s2">            patterns_file (str, optional): Path to the file containing regex patterns to exclude.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            google.cloud.storage.blob.Blob: The first blob from the bucket that doesn&#39;t match any pattern.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># Load regex patterns from file</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">patterns_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">patterns_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>

        <span class="c1"># Get the bucket</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        
        <span class="c1"># List all blobs in the bucket</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blobs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;No blobs found in bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39;.&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Filter blobs based on regex patterns</span>
        <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First valid blob selected: </span><span class="si">{</span><span class="n">blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">blob</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No valid blobs found after applying regex patterns.&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
First valid blob selected: result-10.json
First blob name: result-10.json
</code></pre>
<h3 id="download-the-data">Download the data<a href="#download-the-data" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Now I need to process the information. First off i need to grab the data from the blob</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">download_blob_to_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Downloads a blob from the specified bucket to memory.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            bucket_name (str): Name of the bucket.
</span><span class="s2">            blob_name (str): Name of the blob to download.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            string: The string content of the blob.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># Get the bucket</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        
        <span class="c1"># Get the blob</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">)</span>

        <span class="c1"># Download the blob to a string</span>
        <span class="n">blob_data</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">download_as_string</span><span class="p">()</span>
        
        <span class="c1"># Parse the JSON content</span>
        <span class="c1"># json_content = json.loads(blob_data)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Blob &#39;</span><span class="si">{</span><span class="n">blob_name</span><span class="si">}</span><span class="s2">&#39; downloaded to memory.&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blob_data</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


<span class="c1">#download to memory</span>

    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">blob_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
    <span class="c1"># create_gcs_bucket(gcs_client, bucket_name)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
First valid blob selected: result-10.json
First blob name: result-10.json
Blob 'result-10.json' downloaded to memory.
b'{&quot;breadcrumbs&quot;: [{&quot;Library of Congress&quot;: &quot;https://www.loc.gov&quot;}, {&quot;Digital Collections&quot;: &quot;https://ww'
</code></pre>
<h4 id="flatten-and-process-the-json">Flatten and process the JSON<a href="#flatten-and-process-the-json" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>There is a ton of information in the json. I need to explore it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>
<span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
<span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
<span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

<span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># if args.local:</span>
<span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

<span class="c1"># Initialize logging</span>
<span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
<span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

<span class="c1"># List Buckets for testing</span>
<span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
<span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

<span class="c1"># Grab A blob from the heap</span>
<span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
<span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


<span class="c1">#download to memory</span>

<span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="n">blob_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
    <span class="c1"># create_gcs_bucket(gcs_client, bucket_name)</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
First valid blob selected: result-10.json
First blob name: result-10.json
Blob 'result-10.json' downloaded to memory.
b'{&quot;breadcrumbs&quot;: [{&quot;Library of Congress&quot;: &quot;https://www.loc.gov&quot;}, {&quot;Digital Collections&quot;: &quot;https://ww'
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">json_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</code></pre></div><pre><code>dict_keys(['breadcrumbs', 'browse', 'categories', 'content', 'content_is_post', 'expert_resources', 'facet_trail', 'facet_views', 'facets', 'form_facets', 'next', 'next_sibling', 'options', 'original_formats', 'pages', 'pagination', 'partof', 'previous', 'previous_sibling', 'research-centers', 'results', 'search', 'shards', 'site_type', 'subjects', 'timestamp', 'title', 'topics', 'views'])
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div><pre><code>{'access_restricted': False,
 'aka': ['http://www.loc.gov/item/usrep308213/',
  'http://www.loc.gov/resource/usrep.usrep308213/',
  'http://www.loc.gov/item/usrep.usrep308213/'],
 'campaigns': [],
 'contributor': ['stone, harlan fiske', 'supreme court of the united states'],
 'date': '1939',
 'dates': ['1939'],
 'digitized': True,
 'extract_timestamp': '2023-12-04T18:41:50.547Z',
 'group': ['usrep103', 'us-report'],
 'hassegments': False,
 'id': 'http://www.loc.gov/item/usrep308213/',
 'image_url': ['https://tile.loc.gov/storage-services/service/ll/usrep/usrep308/usrep308213/usrep308213.gif#h=150&amp;w=100'],
 'index': 631,
 'item': {'call_number': ['Call Number: KF101',
   'Series: Administrative Law',
   'Series: Volume 308'],
  'contributors': ['Stone, Harlan Fiske (Judge)',
   'Supreme Court of the United States (Author)'],
  'created_published': ['1939'],
  'date': '19390000',
  'format': 'periodical',
  'genre': ['Periodical'],
  'language': ['eng'],
  'notes': ['Description: U.S. Reports Volume 308; October Term, 1939; Union Stock Yard &amp; Transit Co. v. United States et al.'],
  'rights': 'no known restrictions on use or reproduction',
  'source_collection': 'U.S. Reports',
  'subjects': ['Livestock',
   'Law',
   'Railroads',
   'Law Library',
   'Supreme Court',
   'United States',
   'Government Documents',
   'Judicial review and appeals',
   'Agency',
   'Tariffs',
   'Interstate commerce',
   'Administrative law and regulatory procedure',
   'U.S. Reports',
   'Common law',
   'Court opinions',
   'Judicial decisions',
   'Court cases',
   'Court decisions',
   'Interstate Commerce Commission (I.C.C.)',
   'Agency jurisdiction',
   'Periodical'],
  'title': 'U.S. Reports: Union Stock Yard Co. v. U.S., 308 U.S. 213 (1939).'},
 'language': ['english'],
 'mime_type': ['image/gif', 'application/pdf'],
 'online_format': ['image', 'pdf'],
 'original_format': ['periodical'],
 'other_title': [],
 'partof': ['u.s. reports: volume 308',
  'u.s. reports: administrative law',
  'law library of congress',
  'united states reports (official opinions of the u.s. supreme court)'],
 'resources': [{'files': 1,
   'image': 'https://tile.loc.gov/storage-services/service/ll/usrep/usrep308/usrep308213/usrep308213.gif',
   'pdf': 'https://tile.loc.gov/storage-services/service/ll/usrep/usrep308/usrep308213/usrep308213.pdf',
   'url': 'https://www.loc.gov/resource/usrep.usrep308213/'}],
 'shelf_id': 'Call Number: KF101 Series: Administrative Law Series: Volume 308',
 'subject': ['administrative law',
  'livestock',
  'railroads',
  'supreme court',
  'united states',
  'court opinions',
  'periodical',
  'agency',
  'interstate commerce',
  'court cases',
  'judicial decisions',
  'law library',
  'interstate commerce commission (i.c.c.)',
  'judicial review and appeals',
  'government documents',
  'administrative law and regulatory procedure',
  'law',
  'common law',
  'court decisions',
  'u.s. reports',
  'tariffs',
  'agency jurisdiction'],
 'subject_major_case_topic': ['administrative law'],
 'timestamp': '2023-12-04T19:05:12.397Z',
 'title': 'U.S. Reports: Union Stock Yard Co. v. U.S., 308 U.S. 213 (1939).',
 'type': ['periodical'],
 'url': 'https://www.loc.gov/item/usrep308213/'}
</code></pre>
<h4 id="use-pandas-to-normalize-the-data">Use Pandas to normalize the data<a href="#use-pandas-to-normalize-the-data" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">       <span class="c1"># Flatten the JSON content</span>
<span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Normalize nested structures</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">item_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
<span class="n">resources_data</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
        
<span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>
<span class="n">df_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>



</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">resources_data</span><span class="p">)</span>
<span class="n">df_resources</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
        
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_item</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_resources</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_main</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># df_call_number = pd.DataFrame(df_item[&#34;call_number&#34;], columns=[&#39;call_number&#39;])</span>
<span class="c1"># df_call_number[&#39;id&#39;] = json_data[&#34;results&#34;][0][&#39;id&#39;]  # Add &#39;id&#39; for joining</span>

<span class="n">call_numbers</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call_number&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">call_numbers</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_number&#39;</span><span class="p">])</span>
<span class="n">df_call_number</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
        
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_call_number</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">subjects</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">])</span>
<span class="n">df_subjects</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
        
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">df_subjects</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">notes</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
<span class="n">df_notes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
<span class="n">df_notes</span>
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h5 id="putting-it-together">Putting it together<a href="#putting-it-together" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_main</span>

<span class="k">def</span> <span class="nf">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>
    <span class="n">df_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_item</span>

<span class="k">def</span> <span class="nf">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">resources_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">resources_data</span><span class="p">)</span>
    <span class="n">df_resources</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_resources</span>

<span class="k">def</span> <span class="nf">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">call_numbers</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call_number&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">call_numbers</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_number&#39;</span><span class="p">])</span>
    <span class="n">df_call_number</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_call_number</span>

<span class="k">def</span> <span class="nf">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">contributors</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contributors&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">contributors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">])</span>
    <span class="n">df_contributors</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_contributors</span>

<span class="k">def</span> <span class="nf">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">])</span>
    <span class="n">df_subjects</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_subjects</span>

<span class="k">def</span> <span class="nf">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
    <span class="n">df_notes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_notes</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BigQueryClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

    <span class="c1"># initialize bq</span>

    <span class="n">bq_client</span> <span class="o">=</span> <span class="n">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>

    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>


<span class="c1">#download to memory</span>

    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">blob_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
    <span class="c1"># create_gcs_bucket(gcs_client, bucket_name)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">]</span>

    <span class="c1"># Initialize lists to hold DataFramesdf_notes</span>
    <span class="n">df_main_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_item_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_resources_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_call_number_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_contributors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_subjects_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_notes_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">df_main_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_item_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_resources_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_call_number_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_contributors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_subjects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_notes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="c1"># Concatenate all DataFrames</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_main_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_item_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_resources_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_call_number_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_contributors_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_subjects_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_notes_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
First valid blob selected: result-10.json
First blob name: result-10.json
Blob 'result-10.json' downloaded to memory.
b'{&quot;breadcrumbs&quot;: [{&quot;Library of Congress&quot;: &quot;https://www.loc.gov&quot;}, {&quot;Digital Collections&quot;: &quot;https://ww'
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
<span class="c1"># args = parser.parse_args()</span>

<span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BigQueryClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">main_table_id</span> <span class="o">=</span> <span class="s2">&#34;results_staging&#34;</span>
    <span class="n">item_table_id</span> <span class="o">=</span> <span class="s2">&#34;items_staging&#34;</span>
    <span class="n">resources_table_id</span> <span class="o">=</span> <span class="s2">&#34;resources_staging&#34;</span>
    <span class="n">call_number_table_id</span> <span class="o">=</span> <span class="s2">&#34;call_numbers_staging&#34;</span>
    <span class="n">contributors_table_id</span> <span class="o">=</span> <span class="s2">&#34;contributors_staging&#34;</span>
    <span class="n">subjects_table_id</span> <span class="o">=</span> <span class="s2">&#34;subjects_staging&#34;</span>
    <span class="n">notes_table_id</span> <span class="o">=</span> <span class="s2">&#34;notes_staging&#34;</span>
    
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s2">&#34;supreme_court&#34;</span>
    
    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>
    
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>
    
    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>
    
    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>
    
    <span class="n">bq_client</span> <span class="o">=</span> <span class="n">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    
    <span class="c1"># Create the dataset if not exists</span>
    
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
    
    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    
    
    <span class="c1">#download to memory</span>
    
    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    
    <span class="c1"># print(blob_data[0:100])</span>
    <span class="c1"># create_gcs_bucket(gcs_client, bucket_name)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">]</span>
    
    <span class="c1"># Initialize lists to hold DataFrames</span>
    <span class="n">df_main_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_item_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_resources_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_call_number_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_contributors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_subjects_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_notes_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">df_main_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_item_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_resources_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_call_number_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_contributors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_subjects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_notes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    
    <span class="c1"># Concatenate all DataFrames</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_main_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_item_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_resources_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_call_number_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_contributors_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_subjects_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_notes_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Define the BigQuery table schema</span>
    <span class="c1"># main_schema = [bigquery.SchemaField(name, bigquery.enums.SqlTypeNames.STRING) for name in df_main.columns]</span>
    <span class="n">item_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_item</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">resources_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_resources</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">call_number_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_call_number</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">contributors_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_contributors</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">subjects_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_subjects</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">notes_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_notes</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="c1"># Create BigQuery tables</span>
    <span class="c1"># bq_client.create_table(dataset_id, main_table_id, main_schema)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">item_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">resources_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">call_number_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">contributors_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">subjects_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">notes_schema</span><span class="p">)</span>
    
    <span class="c1"># Load DataFrames into BigQuery tables</span>
    <span class="c1"># bq_client.load_dataframe_to_table(dataset_id, main_table_id, df_main)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">df_item</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">df_resources</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">df_call_number</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">df_contributors</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">df_subjects</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">df_notes</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
Dataset supreme_court created.
First valid blob selected: result-10.json
First blob name: result-10.json
Blob 'result-10.json' downloaded to memory.
Table items_staging created in dataset supreme_court.
Table resources_staging created in dataset supreme_court.
Table call_numbers_staging created in dataset supreme_court.
Table contributors_staging created in dataset supreme_court.
Table subjects_staging created in dataset supreme_court.
Table notes_staging created in dataset supreme_court.
Loaded 70 rows into supreme_court:items_staging.
Loaded 70 rows into supreme_court:resources_staging.
Loaded 210 rows into supreme_court:call_numbers_staging.
Loaded 138 rows into supreme_court:contributors_staging.
Loaded 1570 rows into supreme_court:subjects_staging.
Loaded 70 rows into supreme_court:notes_staging.
</code></pre>
<h4 id="moving-the-processed-blobs-to-a-processed-bucket">Moving the Processed blobs to a Processed Bucket<a href="#moving-the-processed-blobs-to-a-processed-bucket" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<h5 id="add-code-to-the-gcs-client-to-enable-deleting-and-copying">Add code to the GCS Client to enable deleting and copying<a href="#add-code-to-the-gcs-client-to-enable-deleting-and-copying" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">copy_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_bucket_name</span><span class="p">,</span> <span class="n">source_blob_name</span><span class="p">,</span> <span class="n">destination_bucket_name</span><span class="p">,</span> <span class="n">destination_blob_name</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Copies a blob from one bucket to another.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            source_bucket_name (str): Name of the source bucket.
</span><span class="s2">            source_blob_name (str): Name of the source blob.
</span><span class="s2">            destination_bucket_name (str): Name of the destination bucket.
</span><span class="s2">            destination_blob_name (str): Name of the destination blob.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            google.cloud.storage.blob.Blob: The copied blob.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">source_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">source_bucket_name</span><span class="p">)</span>
        <span class="n">source_blob</span> <span class="o">=</span> <span class="n">source_bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">source_blob_name</span><span class="p">)</span>
        <span class="n">destination_bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">destination_bucket_name</span><span class="p">)</span>
        <span class="n">blob_copy</span> <span class="o">=</span> <span class="n">source_bucket</span><span class="o">.</span><span class="n">copy_blob</span><span class="p">(</span><span class="n">source_blob</span><span class="p">,</span> <span class="n">destination_bucket</span><span class="p">,</span> <span class="n">destination_blob_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blob_copy</span>

<span class="k">def</span> <span class="nf">delete_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        Deletes a blob from the specified bucket.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            bucket_name (str): Name of the bucket.
</span><span class="s2">            blob_name (str): Name of the blob to delete.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">)</span>
        <span class="n">blob</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div><h5 id="add-a-couple-lines-to-the-main-script-to-call-the-new-methods">Add a couple lines to the main script to call the new methods<a href="#add-a-couple-lines-to-the-main-script-to-call-the-new-methods" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="c1"># Move the blob to the processed_results bucket</span>
<span class="n">gcs_client</span><span class="o">.</span><span class="n">copy_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">processed_bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">gcs_client</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Blob </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> moved to </span><span class="si">{</span><span class="n">processed_bucket_name</span><span class="si">}</span><span class="s2"> and deleted from </span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">#### Testing</span>
<span class="c1"># loc_flattener.py</span>
<span class="c1"># library_of_congress_scraper.py</span>

<span class="c1"># loc_flattener.py</span>
<span class="c1"># library_of_congress_scraper.py</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">gcputils.gcpclient</span> <span class="kn">import</span> <span class="n">GCSClient</span>
<span class="kn">from</span> <span class="nn">gcputils.GoogleCloudLogging</span> <span class="kn">import</span> <span class="n">GoogleCloudLogging</span>
<span class="kn">from</span> <span class="nn">gcputils.BigQueryClient</span> <span class="kn">import</span> <span class="n">BigQueryClient</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">from</span> <span class="nn">flatten_json</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">import</span> <span class="nn">google.cloud.logging</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BigQueryClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span> <span class="o">=</span> <span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_gcs_bucket</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error creating bucket: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_main</span>

<span class="k">def</span> <span class="nf">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>
    <span class="n">df_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_item</span>

<span class="k">def</span> <span class="nf">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">resources_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">resources_data</span><span class="p">)</span>
    <span class="n">df_resources</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_resources</span>

<span class="k">def</span> <span class="nf">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">call_numbers</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call_number&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">call_numbers</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_number&#39;</span><span class="p">])</span>
    <span class="n">df_call_number</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_call_number</span>

<span class="k">def</span> <span class="nf">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">contributors</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contributors&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">contributors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">])</span>
    <span class="n">df_contributors</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_contributors</span>

<span class="k">def</span> <span class="nf">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">])</span>
    <span class="n">df_subjects</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_subjects</span>

<span class="k">def</span> <span class="nf">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
    <span class="n">df_notes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_notes</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&#39;Run the script locally or in the cloud.&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--local&#39;, action=&#39;store_true&#39;, help=&#39;Run the script locally with credentials path&#39;)</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">main_table_id</span> <span class="o">=</span> <span class="s2">&#34;results_staging&#34;</span>
    <span class="n">item_table_id</span> <span class="o">=</span> <span class="s2">&#34;items_staging&#34;</span>
    <span class="n">resources_table_id</span> <span class="o">=</span> <span class="s2">&#34;resources_staging&#34;</span>
    <span class="n">call_number_table_id</span> <span class="o">=</span> <span class="s2">&#34;call_numbers_staging&#34;</span>
    <span class="n">contributors_table_id</span> <span class="o">=</span> <span class="s2">&#34;contributors_staging&#34;</span>
    <span class="n">subjects_table_id</span> <span class="o">=</span> <span class="s2">&#34;subjects_staging&#34;</span>
    <span class="n">notes_table_id</span> <span class="o">=</span> <span class="s2">&#34;notes_staging&#34;</span>

    <span class="n">processed_bucket_name</span> <span class="o">=</span> <span class="s2">&#34;loc_flattener_processed&#34;</span>
    
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s2">&#34;supreme_court&#34;</span>
    
    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>
    
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if args.local:</span>
    <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>
    
    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>
    
    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>
    
    <span class="n">bq_client</span> <span class="o">=</span> <span class="n">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span><span class="n">credentials_path</span><span class="p">)</span>
    
    <span class="c1"># Create the dataset if not exists</span>
    
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>

    <span class="c1"># create the processed_bucket if not exists</span>

    <span class="c1"># print(gcs_client.create_bucket(processed_bucket_name))</span>
    
    <span class="c1"># Grab A blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">patterns_file</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;First blob name: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    
    
    <span class="c1">#download to memory</span>
    
    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    
    <span class="c1"># print(blob_data[0:100])</span>
    <span class="c1"># create_gcs_bucket(gcs_client, bucket_name)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">]</span>
    
    <span class="c1"># Initialize lists to hold DataFrames</span>
    <span class="n">df_main_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_item_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_resources_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_call_number_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_contributors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_subjects_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_notes_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">df_main_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_item_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_resources_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_call_number_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_contributors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_subjects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_notes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    
    <span class="c1"># Concatenate all DataFrames</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_main_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_item_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_resources_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_call_number_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_contributors_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_subjects_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_notes_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Define the BigQuery table schema</span>
    <span class="c1"># main_schema = [bigquery.SchemaField(name, bigquery.enums.SqlTypeNames.STRING) for name in df_main.columns]</span>
    <span class="n">item_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_item</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">resources_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_resources</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">call_number_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_call_number</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">contributors_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_contributors</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">subjects_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_subjects</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">notes_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_notes</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="c1"># Create BigQuery tables</span>
    <span class="c1"># bq_client.create_table(dataset_id, main_table_id, main_schema)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">item_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">resources_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">call_number_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">contributors_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">subjects_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">notes_schema</span><span class="p">)</span>
    
    <span class="c1"># Load DataFrames into BigQuery tables</span>
    <span class="c1"># bq_client.load_dataframe_to_table(dataset_id, main_table_id, df_main)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">df_item</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">df_resources</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">df_call_number</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">df_contributors</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">df_subjects</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">df_notes</span><span class="p">)</span>

    <span class="c1"># Move the blob to the processed_results bucket</span>
    <span class="n">gcs_client</span><span class="o">.</span><span class="n">copy_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">processed_bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># gcs_client.delete_blob(bucket_name, first_blob.name)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Blob </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> moved to </span><span class="si">{</span><span class="n">processed_bucket_name</span><span class="si">}</span><span class="s2"> and deleted from </span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</code></pre></div><pre><code>trying creds file
Buckets: ['loc-scraper', 'loc_flattener_processed', 'processed_results', 'smart-axis-421517_cloudbuild']
Dataset supreme_court created.
First valid blob selected: result-10.json
First blob name: result-10.json
Blob 'result-10.json' downloaded to memory.
Table items_staging created in dataset supreme_court.
Table resources_staging created in dataset supreme_court.
Table call_numbers_staging created in dataset supreme_court.
Table contributors_staging created in dataset supreme_court.
Table subjects_staging created in dataset supreme_court.
Table notes_staging created in dataset supreme_court.
Loaded 70 rows into supreme_court:items_staging.
Loaded 70 rows into supreme_court:resources_staging.
Loaded 210 rows into supreme_court:call_numbers_staging.
Loaded 138 rows into supreme_court:contributors_staging.
Loaded 1570 rows into supreme_court:subjects_staging.
Loaded 70 rows into supreme_court:notes_staging.
Blob result-10.json moved to loc_flattener_processed and deleted from loc-scraper
</code></pre>
<h4 id="add-while-true-logic-and-clean-up-the-script">Add while true logic and clean up the script<a href="#add-while-true-logic-and-clean-up-the-script" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">gcputils.gcpclient</span> <span class="kn">import</span> <span class="n">GCSClient</span>
<span class="kn">from</span> <span class="nn">gcputils.GoogleCloudLogging</span> <span class="kn">import</span> <span class="n">GoogleCloudLogging</span>
<span class="kn">from</span> <span class="nn">gcputils.BigQueryClient</span> <span class="kn">import</span> <span class="n">BigQueryClient</span>

<span class="k">def</span> <span class="nf">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GCSClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GoogleCloudLogging</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BigQueryClient</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="o">=</span><span class="n">credentials_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_gcs_buckets</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Buckets:&#34;</span><span class="p">,</span> <span class="n">buckets</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buckets: </span><span class="si">{</span><span class="n">buckets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error listing buckets: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_gcs_bucket</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error creating bucket: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_main</span>

<span class="k">def</span> <span class="nf">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>
    <span class="n">df_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_item</span>

<span class="k">def</span> <span class="nf">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">resources_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">resources_data</span><span class="p">)</span>
    <span class="n">df_resources</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_resources</span>

<span class="k">def</span> <span class="nf">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">call_numbers</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call_number&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">call_numbers</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_number&#39;</span><span class="p">])</span>
    <span class="n">df_call_number</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_call_number</span>

<span class="k">def</span> <span class="nf">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">contributors</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contributors&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">contributors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">])</span>
    <span class="n">df_contributors</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_contributors</span>

<span class="k">def</span> <span class="nf">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">])</span>
    <span class="n">df_subjects</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_subjects</span>

<span class="k">def</span> <span class="nf">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">item_data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">item_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
    <span class="n">df_notes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>  <span class="c1"># Add &#39;id&#39; for joining</span>
    <span class="k">return</span> <span class="n">df_notes</span>

<span class="k">def</span> <span class="nf">create_tables_and_schemas</span><span class="p">(</span><span class="n">bq_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">,</span> <span class="n">gcs_client</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
    <span class="c1"># Define the BigQuery table schema</span>
    <span class="n">main_table_id</span> <span class="o">=</span> <span class="s2">&#34;results_staging&#34;</span>
    <span class="n">item_table_id</span> <span class="o">=</span> <span class="s2">&#34;items_staging&#34;</span>
    <span class="n">resources_table_id</span> <span class="o">=</span> <span class="s2">&#34;resources_staging&#34;</span>
    <span class="n">call_number_table_id</span> <span class="o">=</span> <span class="s2">&#34;call_numbers_staging&#34;</span>
    <span class="n">contributors_table_id</span> <span class="o">=</span> <span class="s2">&#34;contributors_staging&#34;</span>
    <span class="n">subjects_table_id</span> <span class="o">=</span> <span class="s2">&#34;subjects_staging&#34;</span>
    <span class="n">notes_table_id</span> <span class="o">=</span> <span class="s2">&#34;notes_staging&#34;</span>

    <span class="c1"># Assuming the first blob provides a sample structure</span>
    <span class="n">sample_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">)</span>
    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">sample_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Use the first result as a sample</span>

    <span class="n">df_main</span> <span class="o">=</span> <span class="n">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">main_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_main</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">item_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_item</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">resources_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_resources</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">call_number_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_call_number</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">contributors_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_contributors</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">subjects_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_subjects</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">notes_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">SqlTypeNames</span><span class="o">.</span><span class="n">STRING</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df_notes</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># Create BigQuery tables</span>
    <span class="c1"># bq_client.create_table(dataset_id, main_table_id, main_schema)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">item_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">resources_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">call_number_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">contributors_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">subjects_schema</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">notes_schema</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_blob</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">,</span> <span class="n">bq_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">processed_bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
    <span class="n">main_table_id</span> <span class="o">=</span> <span class="s2">&#34;results_staging&#34;</span>
    <span class="n">item_table_id</span> <span class="o">=</span> <span class="s2">&#34;items_staging&#34;</span>
    <span class="n">resources_table_id</span> <span class="o">=</span> <span class="s2">&#34;resources_staging&#34;</span>
    <span class="n">call_number_table_id</span> <span class="o">=</span> <span class="s2">&#34;call_numbers_staging&#34;</span>
    <span class="n">contributors_table_id</span> <span class="o">=</span> <span class="s2">&#34;contributors_staging&#34;</span>
    <span class="n">subjects_table_id</span> <span class="o">=</span> <span class="s2">&#34;subjects_staging&#34;</span>
    <span class="n">notes_table_id</span> <span class="o">=</span> <span class="s2">&#34;notes_staging&#34;</span>

    <span class="c1"># Grab a blob from the heap</span>
    <span class="n">first_blob</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">pop_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_blob</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processing blob: </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="c1"># Download to memory</span>
    <span class="n">blob_data</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">download_blob_to_memory</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s2">&#34;results&#34;</span><span class="p">]</span>

    <span class="c1"># Initialize lists to hold DataFrames</span>
    <span class="n">df_main_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_item_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_resources_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_call_number_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_contributors_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_subjects_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_notes_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">df_main_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_main</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_item_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_item</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_resources_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_resources</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_call_number_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_call_numbers</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_contributors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_contributors</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_subjects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_subjects</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">df_notes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalize_notes</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="c1"># Concatenate all DataFrames</span>
    <span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_main_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_item_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_resources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_resources_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_call_number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_call_number_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_contributors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_contributors_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_subjects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_subjects_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_notes_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load DataFrames into BigQuery tables</span>
    <span class="c1"># bq_client.load_dataframe_to_table(dataset_id, main_table_id, df_main)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">item_table_id</span><span class="p">,</span> <span class="n">df_item</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">resources_table_id</span><span class="p">,</span> <span class="n">df_resources</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">call_number_table_id</span><span class="p">,</span> <span class="n">df_call_number</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">contributors_table_id</span><span class="p">,</span> <span class="n">df_contributors</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">subjects_table_id</span><span class="p">,</span> <span class="n">df_subjects</span><span class="p">)</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">load_dataframe_to_table</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">notes_table_id</span><span class="p">,</span> <span class="n">df_notes</span><span class="p">)</span>

    <span class="c1"># Move the blob to the processed_results bucket</span>
    <span class="n">gcs_client</span><span class="o">.</span><span class="n">copy_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">processed_bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">gcs_client</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Blob </span><span class="si">{</span><span class="n">first_blob</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> moved to </span><span class="si">{</span><span class="n">processed_bucket_name</span><span class="si">}</span><span class="s2"> and deleted from </span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Run the script locally or in the cloud.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--local&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run the script locally with credentials path&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">dataset_id</span> <span class="o">=</span> <span class="s2">&#34;supreme_court&#34;</span>
    <span class="n">patterns_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PATTERNS_FILE&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude.txt&#39;</span><span class="p">)</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_PROJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;smart-axis-421517&#39;</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUCKET_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;loc-scraper&#39;</span><span class="p">)</span>
    <span class="n">processed_bucket_name</span> <span class="o">=</span> <span class="s2">&#34;processed_results&#34;</span>

    <span class="n">credentials_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
        <span class="n">credentials_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCP_CREDENTIALS_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;secret.json&#39;</span><span class="p">)</span>

    <span class="c1"># Initialize logging</span>
    <span class="n">logging_client</span> <span class="o">=</span> <span class="n">initialize_google_cloud_logging_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">logging_client</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="c1"># List Buckets for testing</span>
    <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">initialize_gcs_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>
    <span class="n">list_gcs_buckets</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">)</span>

    <span class="c1"># Create the processed_results bucket if not exists</span>
    <span class="c1"># gcs_client.create_bucket(processed_bucket_name)</span>

    <span class="n">bq_client</span> <span class="o">=</span> <span class="n">initialize_bq_client</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">credentials_path</span><span class="p">)</span>

    <span class="c1"># Create the dataset if not exists</span>
    <span class="n">bq_client</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>

    <span class="c1"># Create tables and schemas</span>
    <span class="n">create_tables_and_schemas</span><span class="p">(</span><span class="n">bq_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">,</span> <span class="n">gcs_client</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">)</span>
    <span class="c1"># def create_tables_and_schemas(bq_client, bucket_name, patterns_file, gcs_client, dataset_id):</span>

    <span class="c1"># Process blobs in a loop</span>
    <span class="k">while</span> <span class="n">process_blob</span><span class="p">(</span><span class="n">gcs_client</span><span class="p">,</span> <span class="n">bq_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">processed_bucket_name</span><span class="p">,</span> <span class="n">patterns_file</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Processed a blob, checking for more...&#34;</span><span class="p">)</span>
        

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>


</code></pre></div><h3 id="gcp-cloud-run">GCP Cloud Run<a href="#gcp-cloud-run" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I want this to run autonomously for me on GCP</p>
<p>To do this I will need to</p>
<ol>
<li>Create a DockerFile</li>
<li>Build the image on gcp</li>
<li>create a job to run it</li>
</ol>
<h3 id="create-the-dockerfile">Create the DockerFile<a href="#create-the-dockerfile" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>My Dockerfile looks something like this. Ignore the quickstart code thta i&rsquo;ve commente dout. I use that as a reference.</p>
<p><a href="https://raw.githubusercontent.com/justin-napolitano/loc_normalizer/main/Dockerfile">GH Link</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># # Use the Alpine Linux base image</span><span class="w">
</span><span class="w"></span><span class="c"># FROM alpine:latest</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># # Set the working directory inside the container</span><span class="w">
</span><span class="w"></span><span class="c"># WORKDIR /app</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># # Copy a simple script that prints &#34;Hello, World!&#34; into the container</span><span class="w">
</span><span class="w"></span><span class="c"># COPY /src/hello.sh .</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># # Make the script executable</span><span class="w">
</span><span class="w"></span><span class="c"># RUN chmod +x hello.sh</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># # Define the command to run when the container starts</span><span class="w">
</span><span class="w"></span><span class="c"># CMD [&#34;./hello.sh&#34;]</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Use the official Python image from Docker Hub</span><span class="w">
</span><span class="w"></span><span class="l">FROM python:3.10-slim</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Set the working directory in the container</span><span class="w">
</span><span class="w"></span><span class="l">WORKDIR /app</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Copy the current directory contents into the container at /app</span><span class="w">
</span><span class="w"></span><span class="l">COPY ./src /app</span><span class="w">
</span><span class="w"></span><span class="l">COPY requirements.txt /app</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Install any needed dependencies specified in requirements.txt</span><span class="w">
</span><span class="w"></span><span class="l">RUN pip install --no-cache-dir -r requirements.txt</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Run the Python script when the container launches</span><span class="w">
</span><span class="w"></span><span class="l">CMD [&#34;python&#34;, &#34;loc_scraper.py&#34;]</span><span class="w">
</span></code></pre></div><h4 id="using-cloudbuild">Using Cloudbuild<a href="#using-cloudbuild" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>I want to automate the entire build and deploy process by passing the steps to google&rsquo;s cloud build service.</p>
<p>My <a href="https://github.com/justin-napolitano/loc_normalizer/blob/main/src/cloudbuild.yaml">file</a> looks like this&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">
</span><span class="w"></span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gcr.io/cloud-builders/docker&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-t&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gcr.io/$PROJECT_ID/$IMAGE_NAME&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gcr.io/cloud-builders/docker&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;push&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gcr.io/$PROJECT_ID/$IMAGE_NAME&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gcr.io/cloud-builders/gcloud&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$SERVICE_NAME&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">           </span><span class="s1">&#39;--image&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gcr.io/$PROJECT_ID/$IMAGE_NAME&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">           </span><span class="s1">&#39;--platform&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;managed&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">           </span><span class="s1">&#39;--region&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$REGION&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">           </span><span class="s1">&#39;--allow-unauthenticated&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">substitutions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">_PROJECT_ID</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;smart-axis-421517&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">_IMAGE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loc-flattener-image&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loc-flattener&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">_REGION</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;us-west2&#39;</span><span class="w">  </span><span class="c"># e.g., us-central1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1200s&#39;</span><span class="w">
</span></code></pre></div><h4 id="submit-the-build">Submit the build<a href="#submit-the-build" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>To sbumit the build run the following from the cli or save to as script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud builds submit --config cloudbuild.yaml .
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
</code></pre></div>
			</div>

<div class="related-posts thin">
	<h2></h2>
	<ul>
	
	<li><a href="jnapolitano.com/posts/l_o_c_scraper/">GCP Cloud Run Job Scraper</a></li>
	
	<li><a href="jnapolitano.com/posts/gh_submodule_sync/">Sync Gh Submodules Across a Super Project</a></li>
	
	<li><a href="jnapolitano.com/posts/gh-pages-workflow/">Hugo Build and Deploy GH Workflow</a></li>
	
	<li><a href="jnapolitano.com/posts/create_deploy_cloud_run_job/">Create and Deploy Cloud Run Job Script</a></li>
	
	<li><a href="jnapolitano.com/posts/hugo-rss-mysql-update/">Automate Posting Hugo Blog to Social Sites (with a db)</a></li>
	
	</ul>
</div>

		</article>
		<div class="post-nav thin">
			<a class="next-post" href="jnapolitano.com/posts/create_deploy_cloud_run_job/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>Create and Deploy Cloud Run Job Script</span>
			</a>
			<a class="prev-post" href="jnapolitano.com/posts/running/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Running</span>
			</a>
		</div>
		<div id="comments" class="thin"></div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2024 <a href="jnapolitano.com">Justin Napolitano</a>
		&#183; JAYBURDINDUSTRIES
		&#183; Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>
		&#183; Theme <a href="https://github.com/1bl4z3r/hermit-V2" target="_blank" rel="noopener">Hermit-V2</a></p>

</footer>
<script async src="/jnapolitano.com/js/bundle.min.5034a061023fdc1bbf821910f95d3bda81bc68ba039a2c1202f0d7027638e80f.js" integrity="sha256-UDSgYQI/3Bu/ghkQ+V072oG8aLoDmiwSAvDXAnY46A8=" crossorigin="anonymous"></script><script async src="/jnapolitano.com/js/link-share.min.20ddc5b895a2cb52c811efd9bcf38168838be5cb8671b12ae2997bf38c34f9f0.js" integrity="sha256-IN3FuJWiy1LIEe/ZvPOBaIOL5cuGcbEq4pl784w0+fA=" crossorigin="anonymous"></script>
</body>

</html>
